<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Portfolio Tracker | Conservative Edition</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<!-- Loader -->
<div class="loader" id="loader">
    <div class="spinner"></div>
    <div class="loader-text">Caricamento dati...</div>
</div>

<div class="container">
    
    <!-- HEADER -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üìä</div>
            <div class="logo-text">
                <h1>Crypto Portfolio</h1>
                <span>Conservative Tracker</span>
            </div>
        </div>
        
        <div class="header-controls">
            <div class="live-indicator">
                <div class="live-dot" id="liveIndicator"></div>
                <span class="live-time">Ultimo: <span id="lastUpdate">--:--:--</span></span>
            </div>
            
            <div class="currency-toggle">
                <button class="currency-btn" data-currency="USD">$ USD</button>
                <button class="currency-btn active" data-currency="EUR">‚Ç¨ EUR</button>
            </div>
            
            <button class="btn" id="editBtn">
                <span class="icon">‚úèÔ∏è</span> Modifica
            </button>

            <button class="btn" onclick="UI.showModal('addTxModal')">
                <span class="icon">üìù</span> Transazione
            </button>

            <button class="btn btn-wallet" id="syncWalletBtn" title="Sincronizza saldi dai wallet">
                <span class="icon">üîó</span> Sync Wallet
            </button>

            <button class="btn btn-primary" id="refreshBtn">
                <span class="icon">üîÑ</span> Aggiorna
            </button>
        </div>
    </header>
    
    <!-- ACTION BANNER -->
    <div class="action-banner hold" id="actionBanner">
        <div class="banner-content">
            <div class="banner-icon">‚úÖ</div>
            <div class="banner-text">
                <h2>Tutto Sotto Controllo</h2>
                <p>Nessun segnale estremo - Mercato neutrale</p>
            </div>
        </div>
        <div class="banner-badge">HODL</div>
    </div>
    
    <!-- RECOMMENDED ACTIONS PANEL -->
    <div class="actions-panel" id="actionsPanel">
        <div class="actions-panel-header">
            <div class="card-title">üéØ Azioni Consigliate</div>
            <div class="actions-panel-subtitle">Basate sul tuo profilo conservativo</div>
        </div>
        <div class="actions-panel-content" id="actionsPanelContent">
            <!-- Generated by JS -->
        </div>
    </div>
    
    <!-- KPI GRID -->
    <div class="kpi-grid">
        <div class="kpi-card highlight">
            <div class="kpi-header">
                <div class="kpi-label">Patrimonio Totale</div>
                <div class="health-dot ok" id="healthIndicator"></div>
            </div>
            <div class="kpi-value" id="kpiTotal">--</div>
            <div class="kpi-sub">
                <span class="kpi-pct" id="kpiPnlPct">--</span>
                <span class="text-muted">dal costo</span>
            </div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-label">Profitto / Perdita</div>
            </div>
            <div class="kpi-value positive" id="kpiPnlValue">--</div>
            <div class="kpi-sub">
                <span class="text-muted">P&L non realizzato</span>
            </div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-label">Fear & Greed Index</div>
                <div class="health-dot ok" id="fngIndicator"></div>
            </div>
            <div class="kpi-value" id="kpiFngValue">--</div>
            <div class="kpi-sub">
                <span id="kpiFngLabel">Caricamento...</span>
            </div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-label">BTC Trend</div>
                <div class="health-dot ok" id="btcIndicator"></div>
            </div>
            <div class="kpi-value" id="kpiBtcValue">--</div>
            <div class="kpi-sub">
                <span id="kpiBtcLabel">vs 200 MA</span>
            </div>
        </div>
    </div>
    
    <!-- MAIN LAYOUT -->
    <div class="main-layout">
        <!-- Chart -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Andamento Portfolio <span onclick="showDebugPanel()" style="cursor:pointer;opacity:0.3;font-size:12px;">üîß</span></div>
                <div class="chart-controls">
                    <label class="btc-toggle" title="Confronta con Bitcoin">
                        <input type="checkbox" id="btcCompareToggle">
                        <span class="btc-toggle-slider"></span>
                        <span class="btc-toggle-label">‚Çø vs BTC</span>
                    </label>
                    <div class="chart-range-buttons">
                        <button class="chart-range-btn" data-range="30">1M</button>
                        <button class="chart-range-btn" data-range="90">3M</button>
                        <button class="chart-range-btn" data-range="180">6M</button>
                        <button class="chart-range-btn active" data-range="365">1Y</button>
                        <button class="chart-range-btn" data-range="0">ALL</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="btc-compare-stats" id="btcCompareStats" style="display: none;">
                    <!-- Generated by JS -->
                </div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Allocation -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Allocazione</div>
            </div>
            <div class="card-body">
                <div class="allocation-container">
                    <div class="allocation-chart">
                        <canvas id="allocationChart"></canvas>
                    </div>
                    <div class="allocation-list" id="allocationList">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ASSET TABLE -->
    <div class="table-container" id="assetTable">
        <div class="table-header">
            <div class="card-title">I Tuoi Asset</div>
            <button class="btn btn-sm" onclick="UI.showModal('addAssetModal')">
                <span class="icon">‚ûï</span> Aggiungi Asset
            </button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Prezzo</th>
                    <th>24h</th>
                    <th>7d</th>
                    <th>30d</th>
                    <th>Quantit√†</th>
                    <th>PMC</th>
                    <th>Valore</th>
                    <th>P&L</th>
                    <th>RSI</th>
                    <th>Surriscaldamento</th>
                    <th>Consiglio</th>
                    <th class="actions-cell"></th>
                </tr>
            </thead>
            <tbody id="assetTbody">
                <!-- Generated by JS -->
            </tbody>
        </table>
    </div>
    
    <!-- CONDITIONS DETECTOR -->
    <div class="conditions-grid">
        <div class="conditions-card">
            <div class="conditions-header">
                <div class="conditions-title buy">
                    üìà Condizioni Accumulo
                </div>
                <div class="conditions-count positive" id="buyCount">0/3</div>
            </div>
            <div class="conditions-list" id="buyConditions">
                <!-- Generated by JS -->
            </div>
        </div>
        
        <div class="conditions-card sell">
            <div class="conditions-header">
                <div class="conditions-title sell">
                    üìâ Condizioni Prudenza
                </div>
                <div class="conditions-count negative" id="sellCount">0/3</div>
            </div>
            <div class="conditions-list" id="sellConditions">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>
    
    <!-- CALCULATOR -->
    <div class="calculator-panel" id="calculatorPanel">
        <div class="card-title">üí± Calcolatore Acquisto</div>
        
        <div class="calculator-content">
            <div class="calc-row">
                <div class="calc-field">
                    <label>üîç Cerca coin</label>
                    <div class="search-wrapper">
                        <input type="text" 
                               id="coinSearch" 
                               class="calc-input" 
                               placeholder="Cerca per nome o simbolo..."
                               autocomplete="off">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                </div>
                
                <div class="calc-field selected-coin" id="selectedCoinField" style="display: none;">
                    <label>Coin selezionata</label>
                    <div class="selected-coin-display" id="selectedCoinDisplay">
                        <div class="selected-coin-info">
                            <span class="selected-coin-icon" id="selectedCoinIcon">‚Çø</span>
                            <div class="selected-coin-text">
                                <span class="selected-coin-symbol" id="selectedCoinSymbol">BTC</span>
                                <span class="selected-coin-name" id="selectedCoinName">Bitcoin</span>
                            </div>
                        </div>
                        <button class="btn-clear-coin" onclick="Calculator.clearCoin()">‚úï</button>
                    </div>
                </div>
            </div>
            
            <div class="calc-row">
                <div class="calc-field">
                    <label>üìä Prezzo attuale</label>
                    <div class="calc-price-display">
                        <span class="calc-price" id="calcPrice">--</span>
                        <span class="calc-live-dot" id="calcLiveDot">üî¥</span>
                    </div>
                </div>
                
                <div class="calc-field">
                    <label>üí∂ Importo da investire</label>
                    <div class="calc-input-wrapper">
                        <input type="number" 
                               id="calcAmount" 
                               class="calc-input calc-amount-input" 
                               placeholder="0.00"
                               min="0"
                               step="0.01">
                        <span class="calc-currency" id="calcCurrency">EUR</span>
                    </div>
                </div>
            </div>
            
            <div class="calc-result" id="calcResult">
                <div class="calc-result-label">üì¶ Puoi comprare</div>
                <div class="calc-result-value" id="calcResultValue">--</div>
                <div class="calc-result-note" id="calcResultNote">Seleziona una coin e inserisci un importo</div>
            </div>
        </div>
    </div>
    
</div>

<!-- ADD TRANSACTION MODAL -->
<div class="modal" id="addTxModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìù Registra Transazione</h2>
            <button class="modal-close" onclick="UI.hideModal('addTxModal')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="addTxForm" onsubmit="UI.handleAddTransaction(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="txType" required>
                            <option value="BUY">üü¢ Acquisto</option>
                            <option value="SELL">üî¥ Vendita</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Asset</label>
                        <input type="text" id="txAsset" placeholder="Es: XRP, BTC" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantit√†</label>
                        <input type="number" id="txQty" step="0.00000001" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>Prezzo (USD)</label>
                        <input type="number" id="txPrice" step="0.00000001" placeholder="0.00" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Note (opzionale)</label>
                    <input type="text" id="txNote" placeholder="Es: Accumulo durante il dip">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="UI.hideModal('addTxModal')">Annulla</button>
                    <button type="submit" class="btn btn-primary">Registra</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ADD ASSET MODAL -->
<div class="modal" id="addAssetModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚ûï Aggiungi Asset</h2>
            <button class="modal-close" onclick="UI.hideModal('addAssetModal')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="addAssetForm" onsubmit="UI.handleAddAsset(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Simbolo *</label>
                        <input type="text" id="assetSymbol" placeholder="Es: BTC, ETH" required>
                    </div>
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="assetName" placeholder="Es: Bitcoin">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantit√† *</label>
                        <input type="number" id="assetQty" step="0.00000001" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>Prezzo Medio (USD) *</label>
                        <input type="number" id="assetAvgPrice" step="0.00000001" placeholder="0.00" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="UI.hideModal('addAssetModal')">Annulla</button>
                    <button type="submit" class="btn btn-primary">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- WALLET CONFIG MODAL -->
<div class="modal" id="walletModal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>üîó Configura Wallet</h2>
            <button class="modal-close" onclick="UI.hideModal('walletModal')">√ó</button>
        </div>
        <div class="modal-body">
            <p class="modal-description">Inserisci gli indirizzi dei tuoi wallet per sincronizzare automaticamente i saldi dalla blockchain.</p>

            <div class="wallet-config-list" id="walletConfigList">
                <!-- Generated by JS -->
            </div>

            <div class="form-actions">
                <button type="button" class="btn" onclick="UI.hideModal('walletModal')">Chiudi</button>
                <button type="button" class="btn btn-primary" onclick="UI.syncAllWallets()">
                    <span class="icon">üîÑ</span> Sincronizza Tutti
                </button>
            </div>

            <!-- Import Transactions Section -->
            <div class="import-section">
                <h3>üì• Importa Storico Transazioni</h3>
                <p class="modal-description">Legge le transazioni dalla blockchain e calcola automaticamente il prezzo medio di carico (PMC).</p>

                <button type="button" class="btn btn-wallet" id="btnImportTx" onclick="UI.importTransactionsFromBlockchain()">
                    <span class="icon">üìä</span> Importa Transazioni
                </button>

                <div class="import-progress" id="importProgress" style="display: none;">
                    Lettura in corso...
                </div>

                <div class="import-result" id="importResult">
                    <!-- Results will be shown here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer with Clear Cache Button -->
<footer class="dashboard-footer">
    <div class="footer-content">
        <span class="footer-version">Crypto Portfolio Tracker v1.2</span>
        <button class="btn-clear-cache" onclick="clearCacheAndReload()">
            <span class="icon">üóëÔ∏è</span> Cancella Cache e Aggiorna
        </button>
        <span class="footer-info">Ultimo deploy: Dec 2025</span>
    </div>
</footer>

<!-- JavaScript Modules -->
<script src="js/config.js"></script>
<script src="js/api.js"></script>
<script src="js/portfolio.js"></script>
<script src="js/analysis.js"></script>
<script src="js/charts.js"></script>
<script src="js/calculator.js"></script>
<script src="js/wallet.js"></script>
<script src="js/app.js"></script>

<!-- Clear Cache Function -->
<script>
function clearCacheAndReload() {
    if (confirm('Vuoi cancellare tutti i dati salvati e ricaricare la pagina?\n\nQuesto resetter√†:\n- Portfolio ai valori predefiniti\n- Transazioni\n- Impostazioni wallet\n- Storico snapshots\n\nI dati verranno ricaricati dal server.')) {
        // Clear all localStorage keys
        const keys = Object.values(CONFIG.STORAGE);
        keys.forEach(key => {
            localStorage.removeItem(key);
            console.log(`Removed: ${key}`);
        });

        // Also clear wallet sync timestamp
        localStorage.removeItem('cpt_last_sync_v1');
        localStorage.removeItem('cpt_wallets_v1');

        // Show feedback
        alert('Cache cancellata! La pagina verr√† ricaricata.');

        // Force reload from server (bypass browser cache)
        window.location.reload(true);
    }
}
</script>

</body>
</html>
